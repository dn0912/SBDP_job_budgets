<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Serverless Big Data Processing Budget Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
  
    body {
      font: 13px Helvetica, Arial;
      display: flex;
      flex-direction: column;
    }
  
    form {
      display: flex;
      background: #5E6772;
      padding: 3px;
      width: 100%;
      border-radius: 5px;
      height: 40px;
    }
  
    form input {
      border: 0;
      padding: 10px;
      width: 90%;
      margin-right: 0.5%;
      border-radius: 5px;
    }
  
    form button {
      width: 9%;
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
      border-radius: 5px;
      color: white;
    }
    .submit-buttons {
      width: 100px;
    }
  
    #messages {
      list-style-type: none;
      margin: 130px 0 0 0;
    }
  
    #messages li {
      padding: 5px 10px;
    }
  
    #messages li:nth-child(odd) {
      background: #eee;
    }

    #clear-button {
      border-radius: 5px;
      color: #d24336;
      height: 30px;
    }

    .header {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1;
      box-shadow: 0 0 5px 5px #c3c3c3;
      flex-direction: column;
    }

    table {
      border-spacing: 5px 10px;
    }

    #messages-table tr {
      padding: 5px;
    }
    #messages-table tr:nth-child(odd) {
      background: #eee;
    }
  </style>
</head>

<body>
  <div class="header">
    <form name="get-job-status-form" id="get-job-status-form" action="">
      <input id="get-job-costs-input" autocomplete="off"
        placeholder="Enter job ID here e.g. '81abeb31-e4e7-4dfc-a216-f3fa95252643'" />
      <button class="submit-buttons">Get job costs</button>
    </form>
    <form name="start-job-and-trace-form" id="start-job-and-trace-form" action="">
      <input id="start-job-and-trace-jobUrl-input" autocomplete="off"
        placeholder="Entry point URL of instrumented app" />
      <input id="start-job-and-trace-budgetLimit-input" autocomplete="off"
        placeholder="Budget limit of app ($) e.g. 0.0245; Default: 0" />
      <input id="start-job-and-trace-appId-input" autocomplete="off"
        placeholder="(Opt) - App ID of your uploaded Cloudformation stack" />
      <input id="start-job-and-trace-tracePeriod-input" autocomplete="off"
        placeholder="(Opt) Duration of tracing (in seconds) - fetching trace in 500ms period" />
      <button class="submit-buttons">Start job</button>
    </form>
    <button id="clear-button">Clear page</button>
  </div>
  <ul id="messages"></ul>
  <table>
    <thead>
      <tr>
        <th>Lambda n$</th>
        <th>SQS n$</th>
        <th>S3 n$</th>
        <th>Total job price (in nano $)</th>
        <th>Total job price in $</th>
        <th>Job budget</th>
        <th>Time passed</th>
        <th>Job ID</th>
        <th>Meta data</th>
      </tr>
    </thead>
    <tbody id="messages-table">
    </tbody>
  </table>


  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script>
    $(function () {
        var socket = io();
        $('#get-job-status-form').submit(function (e) {
          e.preventDefault(); // prevents page reloading
          const inputJobId = $('#get-job-costs-input').val()
          socket.emit('get-job-trace-data', inputJobId);
          socket.emit('subscribe', inputJobId)

          // clear input
          $('#get-job-costs-input').val('');

          $('#messages').append($('<li>').text(`Fetching data from job ID ${inputJobId} ...`));
          return false;
        });

        $('#start-job-and-trace-form').submit(function (e) {
          e.preventDefault(); // prevents page reloading
          const inputJobUrl = $('#start-job-and-trace-jobUrl-input').val() // TODO:
          const inputBudgetLimit = $('#start-job-and-trace-budgetLimit-input').val() || 0 // TODO:
          const inputAppId = $('#start-job-and-trace-appId-input').val()
          const inputTracePeriod = $('#start-job-and-trace-tracePeriod-input').val() // TODO:
          const additionalData = {
            jobUrl: inputJobUrl,
            budgetLimit: inputBudgetLimit,
            appId: inputAppId,
            periodInSecCalculation: inputTracePeriod,
          };

          console.log('+++additionalData', additionalData)

          

          // clear input
          $('#start-job-and-trace-input').val('');

          if(inputJobUrl) {
            $('#messages').append($('<li>').text('Starting job...'));
            $('#messages').append($('<li>').text(`jobUrl: ${inputJobUrl} - budgetLimit: ${inputBudgetLimit} - appId: ${inputAppId} - tracePeriod: ${inputTracePeriod}`));
            socket.emit('start-job-and-trace', additionalData);
          } else {
            $('#messages').append($('<li>').text('Error: Provide job url'));
          }

          return false;
        });
      });

    function displayJobCostsContent(jobCostsDetails) {
      console.log('+++jobCostsDetails', jobCostsDetails)
      const {
        jobId,
        iterationNumber,
        lambdaPrices,
        sqsPrices,
        s3Prices,
        totalJobPrice,
        totalJobPriceInUSD,
        formatedTimePassedSinceJobStart,
        budgetLimit,
        metaData = {},
      } = jobCostsDetails

      const { awsService = '', additionalData = '' } = metaData

      const lambdaPricesListItem = `<strong>Lambda n$:</strong> ${lambdaPrices}  `
      const sqsPricesListItem = `<strong>SQS n$:</strong> ${sqsPrices}  `
      const s3PricesListItem = `<strong>S3 n$:</strong> ${s3Prices}  `
      const totalJobPriceListItem = `<strong>Total job price (in nano $):</strong> ${totalJobPrice}  `
      const totalJobPriceInUSDListItem = `<strong>Total job price in $:</strong> ${totalJobPriceInUSD}  `
      const jobIdListItem = `<strong>Job ID:</strong> ${jobId}   `
      const timepassedListItem = `<strong>Time passed:</strong> ${formatedTimePassedSinceJobStart}   `
      const budgetLimitListItem = `<strong>Job budget:</strong> ${budgetLimit}$   `

      // $('#messages').append('<li>'
      //   + `${iterationNumber >= 0 ? iterationNumber + ' - ' : ''}`
      //   + lambdaPricesListItem
      //   + sqsPricesListItem
      //   + s3PricesListItem
      //   + totalJobPriceListItem
      //   + totalJobPriceInUSDListItem
      //   + budgetLimitListItem
      //   + timepassedListItem
      //   + jobIdListItem
      //   + '</li>');

      const metaDataText = typeof iterationNumber === 'number' ? `Iteration: ${iterationNumber}` : `${awsService} - ${additionalData}`

      $('#messages-table').append('<tr>'
        + '<td>' + lambdaPrices + '</td>'
        + '<td>' + sqsPrices + '</td>'
        + '<td>' + s3Prices + '</td>'
        + '<td>' + totalJobPrice + '</td>'
        + '<td>' + totalJobPriceInUSD + '</td>'
        + '<td>' + budgetLimit + '</td>'
        + '<td>' + formatedTimePassedSinceJobStart + '</td>'
        + '<td>' + jobId + '</td>'
        + '<td>' + metaDataText + '</td>'
      )
    };

    const socket = io();

    $('#clear-button').click(function () {
      socket.emit('test-event', 'hello-world');
      location.reload();
    });

    socket.on('connect', () => {
      $('#messages').append($('<li>').text('Ready'));
    });

    socket.on('disconnect', () => {
      $('#messages').append($('<li>').text('Disconnected'));
    });

    socket.on('stream-job-costs', function(jobCostsDetails) {
      console.log('+++stream-job-costs')
      displayJobCostsContent(jobCostsDetails)
    })

    socket.on('return-job-trace-data', function (jobCostsDetails) {
      displayJobCostsContent(jobCostsDetails)
    });

    socket.on('no-job-found', function (jobId) {
      $('#messages').append($('<li>').text(`Job does not exists with job id ${jobId}`))
    })
  </script>
</body>

</html>
